<!DOCTYPE HTML>
<html>
    <head>
        <title>Î± Leaflet</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"></link>
        <link rel="stylesheet" href="https://unpkg.com/tachyons@4.10.0/css/tachyons.min.css"></link>
        <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
        <script src="leaflet-hash.js"></script>
        <style>
            html, body, #map {
                height:100%;
                background: #eee;
            }
        </style>
    </head>
    <body class="flex sans-serif">
        <div class="flex flex-column flex-grow-1">
            <div class="w-100" id="map"></div>
        </div>
        <script type="module">
            import init, { wasm_render_tile } from './protomaps_alpha_web.js'

            var ratio = window.devicePixelRatio
            const tile_size = 2048/ratio
            var myCrs = L.extend({}, L.CRS.EPSG3857, {
                scale:function (zoom) {
                   return tile_size * Math.pow(2,zoom)
                },
                zoom :function(scale) {
                    return Math.log(scale / tile_size) / Math.LN2
                }
            })

            var map = L.map('map',{crs:myCrs,zoomControl:false})
            var hash = new L.Hash(map)
            if(!location.hash) {
                map.setView([0,0], 1)
            }

            L.control.zoom().addTo(map);


            async function run() {
                await init()
                var CanvasLayer = L.GridLayer.extend({
                    createTile: function(coords,done){
                        var error
                        var tile = L.DomUtil.create('canvas', 'leaflet-tile')
                        if (!this.renderedTiles) this.renderedTiles = 0
                        tile.id = "pmap_alpha_" + this.renderedTiles
                        this.renderedTiles = this.renderedTiles + 1
                        tile.width = 2048
                        tile.height = 2048

                        var api_key = ""
                        var tile_url = `https://a.tile.nextzen.org/tilezen/vector/v1/512/all/${coords.z}/${coords.x}/${coords.y}.mvt?api_key=${api_key}`

                        fetch(tile_url).then(resp => {
                            return resp.arrayBuffer()
                        }).then(buf => {
                            var arr = new Uint8Array(buf)
                            wasm_render_tile(tile.id,arr,coords.z)
                            done(error,tile)
                        })

                        return tile
                    },

                    _removeTile: function (key) {
                        var tile = this._tiles[key]
                        if (!tile) { return }
                        tile.el.width = 0
                        tile.el.height = 0
                        L.DomUtil.remove(tile.el)
                        delete this._tiles[key]
                        this.fire('tileunload', {
                            tile: tile.el,
                            coords: this._keyToTileCoords(key)
                        })
                    },
                })
                var c = new CanvasLayer({tileSize:tile_size,attribution: 'Map Tiles &copy; Nextzen; &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:15,detectRetina:true})
                c.addTo(map)
            }
            run()
        </script>
    </body>
</html>